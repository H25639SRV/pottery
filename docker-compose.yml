version: "3.9"

services:
  # ========================
  # ðŸ—„ï¸ PostgreSQL Database
  # ========================
  db:
    image: postgres:14
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: pottery
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ========================
  # âš™ï¸ Backend (Node + Express) - Production Setup
  # ========================
  backend:
    # Build image tá»« thÆ° má»¥c backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always

    # Sá»­ dá»¥ng env_file (náº¿u cáº§n thiáº¿t cho biáº¿n mÃ´i trÆ°á»ng khÃ¡c)
    env_file:
      - ./backend/.env

    # Káº¿t ná»‘i DB trong máº¡ng ná»™i bá»™ Docker
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/pottery?schema=public
      # ThÃªm biáº¿n mÃ´i trÆ°á»ng cho mÃ´i trÆ°á»ng Production (Náº¿u cáº§n)
      - NODE_ENV=production

    depends_on:
      db:
        condition: service_healthy

    # Ãnh xáº¡ cá»•ng ra Host Ä‘á»ƒ Nginx cÃ³ thá»ƒ truy cáº­p (103.77.240.74:5000)
    ports:
      - "5000:5000"

    # âš ï¸ CHá»ˆ GIá»® CÃC VOLUME CHO Dá»® LIá»†U Cáº¦N LÆ¯U TRá»® (vÃ­ dá»¥: áº£nh upload, log)
    # âš ï¸ ÄÃƒ LOáº I Bá»Ž VOLUME Äá»’NG Bá»˜ MÃƒ NGUá»’N (./backend:/app)
    volumes:
      # LÆ°u áº£nh render, upload, assets ra ngoÃ i host Ä‘á»ƒ dá»… xem vÃ  persistent
      - ./backend/public:/app/public
      - ./backend/src/assets:/app/src/assets

    # Lá»‡nh khá»Ÿi Ä‘á»™ng (Bá» npm run build vÃ¬ nÃ³ Ä‘Ã£ Ä‘Æ°á»£c cháº¡y trong Dockerfile Stage 1)
    command: >
      sh -c "
        npx prisma migrate deploy && 
        node dist/server.js
      "

# ========================
# ðŸ’¾ Volumes
# ========================
volumes:
  pgdata:
