# ===============================
# ğŸ§± STAGE 1: Builder
# ===============================
FROM node:20-bookworm AS builder

WORKDIR /app

# 1ï¸âƒ£ CÃ i Ä‘áº·t thÆ° viá»‡n há»‡ thá»‘ng cáº§n thiáº¿t (cho canvas, sharp, v.v.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    libcairo2-dev \
    libpango1.0-dev \
    libjpeg-dev \
    libgif-dev \
    librsvg2-dev \
    libpng-dev \
    openssl \
    && rm -rf /var/lib/apt/lists/*

# 2ï¸âƒ£ Copy file package.json vÃ  package-lock.json Ä‘á»ƒ cÃ i Ä‘áº·t dependency
COPY package*.json ./

# 3ï¸âƒ£ CÃ i táº¥t cáº£ dependencies (bao gá»“m dev Ä‘á»ƒ build TypeScript)
RUN npm ci

# 4ï¸âƒ£ Copy mÃ£ nguá»“n vÃ  Prisma schema
COPY prisma ./prisma
COPY tsconfig.json .
COPY src ./src
COPY src/assets ./src/assets

# âš™ï¸ ThÃªm binaryTargets cho mÃ´i trÆ°á»ng openssl-1.1.x (náº¿u chÆ°a cÃ³)
# Báº¡n nÃªn cÃ³ Ä‘oáº¡n sau trong prisma/schema.prisma:
# generator client {
#   provider      = "prisma-client-js"
#   binaryTargets = ["native", "debian-openssl-1.1.x"]
# }

# 5ï¸âƒ£ Generate Prisma client (vá»›i binary phÃ¹ há»£p Docker)
RUN npx prisma generate --schema=./prisma/schema.prisma

# 6ï¸âƒ£ Build TypeScript
RUN npm run build

# âœ… Copy thÆ° má»¥c áº£nh máº«u vÃ o dist Ä‘á»ƒ runtime Ä‘á»c Ä‘Æ°á»£c
RUN mkdir -p /app/dist/assets && cp -r ./src/assets/* /app/dist/assets/

# 7ï¸âƒ£ Táº¡o thÆ° má»¥c public cáº§n thiáº¿t
RUN mkdir -p /app/public/uploads /app/public/render_output

# ===============================
# ğŸƒ STAGE 2: Runtime
# ===============================
FROM node:18-slim AS runner

WORKDIR /app

# CÃ i openssl trong runtime (Ä‘á»ƒ Prisma khÃ´ng lá»—i)
RUN apt-get update && apt-get install -y --no-install-recommends openssl && \
    rm -rf /var/lib/apt/lists/*

# Copy file cáº§n thiáº¿t tá»« builder stage
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/public ./public
COPY --from=builder /app/src/assets ./src/assets

# Expose cá»•ng backend
EXPOSE 5000

# ğŸš€ Khá»Ÿi Ä‘á»™ng Prisma & server
CMD npx prisma migrate deploy && node dist/server.js
