FROM node:20-alpine AS build

WORKDIR /app

# =========================================================================
# STAGE 1: BUILD (Chá»©a cÃ´ng cá»¥ biÃªn dá»‹ch vÃ  Node Modules)
#
# Lá»›p nÃ y chá»‰ bá»‹ rebuild náº¿u:
# 1. Base image thay Ä‘á»•i.
# 2. package*.json thay Ä‘á»•i.
# =========================================================================
# 1. CÃ i Ä‘áº·t cÃ¡c gÃ³i BUILD/DEV cáº§n thiáº¿t (QUAN TRá»ŒNG: Pháº£i cháº¡y trÆ°á»›c npm install).
RUN apk update && \
    apk add --no-cache python3 make g++ gcc cairo-dev jpeg-dev pango-dev giflib-dev && \
    rm -rf /var/cache/apk/*

# 2. Copy dependencies vÃ  cÃ i Ä‘áº·t (lá»›p nÃ y tÃ¡i sá»­ dá»¥ng cache náº¿u package*.json khÃ´ng Ä‘á»•i)
COPY package*.json ./
RUN npm install

# 3. Copy Prisma schema vÃ  táº¡o Client (Ä‘áº£m báº£o file client Ä‘Æ°á»£c táº¡o)
COPY prisma ./prisma/
RUN npx prisma generate --schema=./prisma/schema.prisma

# 4. Copy mÃ£ nguá»“n vÃ  Build TypeScript (chá»‰ cháº¡y láº¡i khi mÃ£ nguá»“n thay Ä‘á»•i)
COPY . .
RUN npm run build 

# ===============================
# ğŸƒ STAGE 2: Runtime (Image cuá»‘i cÃ¹ng)
# ===============================
FROM node:20-alpine

WORKDIR /app

# âš ï¸ BÆ¯á»šC QUAN TRá»ŒNG: CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n chia sáº» (shared libraries) 
# nhÆ° libcairo.so.2 cáº§n thiáº¿t cho 'canvas' hoáº¡t Ä‘á»™ng trong Runtime Stage.
# CÃ¡c thÆ° viá»‡n nÃ y khÃ´ng cÃ³ trong image node:20-alpine cÆ¡ báº£n.
RUN apk update && \
    apk add --no-cache cairo jpeg pango giflib && \
    rm -rf /var/cache/apk/*

# Copy built code
COPY --from=build /app/dist ./dist

# Copy node_modules (Ä‘Ã£ Ä‘Æ°á»£c biÃªn dá»‹ch á»Ÿ Stage 1)
COPY --from=build /app/node_modules ./node_modules

# Copy thÆ° má»¥c prisma (cáº§n cho migration)
COPY --from=build /app/prisma ./prisma

# Expose port
EXPOSE 5000

# ğŸš€ Lá»†NH KHá»I Äá»˜NG CUá»I CÃ™NG
CMD [ "/bin/sh", "-c", "npx prisma migrate deploy --schema=prisma/schema.prisma && node dist/server.js" ]