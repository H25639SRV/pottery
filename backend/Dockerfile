# ===============================
# üß± STAGE 1: Builder
# ===============================
# D√πng Node 20 cho c·∫£ 2 stage ƒë·ªÉ tr√°nh l·ªói th∆∞ vi·ªán C++ (canvas/sharp)
FROM node:20-bookworm AS builder

WORKDIR /app

# 1Ô∏è‚É£ C√†i ƒë·∫∑t th∆∞ vi·ªán h·ªá th·ªëng
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential pkg-config libcairo2-dev libpango1.0-dev \
    libjpeg-dev libgif-dev librsvg2-dev libpng-dev openssl \
    && rm -rf /var/lib/apt/lists/*

# 2Ô∏è‚É£ Copy package files
COPY package*.json ./
RUN npm ci

# 3Ô∏è‚É£ Copy source
COPY prisma ./prisma
COPY tsconfig.json .
COPY src ./src

# T·∫°o th∆∞ m·ª•c template
RUN mkdir -p /app/public/templates
COPY src/assets/render.png /app/public/templates/render.png

# 4Ô∏è‚É£ Build
RUN npx prisma generate --schema=./prisma/schema.prisma
RUN npm run build

# üî• T·ªêI ∆ØU: X√≥a th∆∞ vi·ªán dev v√† N√©n node_modules ƒë·ªÉ copy nhanh h∆°n
RUN npm prune --production
RUN tar -cf node_modules.tar node_modules

# ===============================
# üèÉ STAGE 2: Runtime
# ===============================
FROM node:20-slim AS runner

WORKDIR /app

# C√†i ƒë·∫∑t th∆∞ vi·ªán Runtime
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssl \
    libcairo2 libpango-1.0-0 libpangocairo-1.0-0 \
    libgif7 librsvg2-2 \
    fontconfig fonts-dejavu-core \
    && rm -rf /var/lib/apt/lists/*

# T·∫°o th∆∞ m·ª•c output
RUN mkdir -p /app/public/uploads /app/public/render_output

# Copy file package.json
COPY --from=builder /app/package*.json ./

# üî• COPY FILE N√âN
COPY --from=builder /app/node_modules.tar ./
# Gi·∫£i n√©n v√† x√≥a file tar
RUN tar -xf node_modules.tar && rm node_modules.tar

# Copy c√°c ph·∫ßn c√≤n l·∫°i
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/public ./public

EXPOSE 5000

# L·ªánh CMD ƒë∆°n gi·∫£n (ch·ªâ ch·∫°y server), migration s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi docker-compose command
CMD ["node", "dist/server.js"]