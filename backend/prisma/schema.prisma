generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/*
  User, Product, Cart, Message
*/

model User {
  id        Int      @id @default(autoincrement())
  username  String
  email     String   @unique
  password  String
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())

  carts   Cart[]
  products Product[]
  orders  Order[] // ThÃªm: LiÃªn káº¿t Ä‘áº¿n ÄÆ¡n hÃ ng
  customRequests CustomOrderRequest[] // ThÃªm: LiÃªn káº¿t Ä‘áº¿n YÃªu cáº§u Custom
}

// ThÃªm Model Category má»›i
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique // TÃªn danh má»¥c (VÃ­ dá»¥: BÃ¬nh hoa, áº¤m chÃ©n)
  products  Product[] // Quan há»‡ 1-nhiá»u: 1 danh má»¥c cÃ³ nhiá»u sáº£n pháº©m
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// Cáº­p nháº­t Model Product
model Product {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?  @db.Text
  story        String?  @db.Text
  price        Float
  image        String
  subImages    String[] @default([])
  stock        Int      @default(0)
  
  // ThÃ´ng sá»‘ ká»¹ thuáº­t
  sku          String?  @unique
  dimensions   String?
  weight       String?
  material     String?
  origin       String?
  availability String?

  // ğŸ†• THÃŠM LIÃŠN Káº¾T CATEGORY
  categoryId   Int?     // CÃ³ thá»ƒ null náº¿u sáº£n pháº©m chÆ°a phÃ¢n loáº¡i
  category     Category? @relation(fields: [categoryId], references: [id])

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  userId       Int?
  user         User?    @relation(fields: [userId], references: [id])

  cartItems    CartItem[]
  orderItems   OrderItem[]
}

model Cart {
  id        Int      @id @default(autoincrement())
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]
}

model CartItem {
  id        Int     @id @default(autoincrement())
  cartId    Int
  productId Int
  quantity  Int     @default(1)

  cart    Cart    @relation(fields: [cartId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

// THÃŠM Má»šI: Model ÄÆ¡n hÃ ng
model Order {
  id        Int      @id @default(autoincrement())
  userId    Int
  createdAt DateTime @default(now())
  status    String   @default("PENDING") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELED
  total     Float
  address   String?
  paymentMethod String   @default("cod")
  user  User        @relation(fields: [userId], references: [id])
  items OrderItem[]
}

// THÃŠM Má»šI: Model Chi tiáº¿t ÄÆ¡n hÃ ng
model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int
  price     Float // GiÃ¡ táº¡i thá»i Ä‘iá»ƒm mua

  // ThÃªm trÆ°á»ng cho sáº£n pháº©m custom náº¿u cáº§n
  isCustom    Boolean @default(false)
  customImage String?

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

// THÃŠM Má»šI: Model YÃªu cáº§u Custom
model CustomOrderRequest {
Â  idÂ  Â  Â  Â  Â  IntÂ  Â  Â  @id @default(autoincrement())
Â  userIdÂ  Â  Â  Int
  // [ÄÃƒ XÃ“A]: baseProductId Int?
  // [ÄÃƒ XÃ“A]: product Product? @relation(...)

Â  vaseNameÂ  Â  String // TÃªn bÃ¬nh (render.png)
Â  patternFile String // TÃªn file pattern Ä‘Ã£ upload
Â  resultImage String // ÄÆ°á»ng dáº«n áº£nh Ä‘Ã£ render
Â  statusÂ  Â  Â  StringÂ  Â @default("PENDING") // PENDING (Chá» duyá»‡t), APPROVED (Duyá»‡t), REJECTED (Tá»« chá»‘i)
Â  adminNotesÂ  String?Â  // Ghi chÃº cá»§a Admin
Â  createdAtÂ  Â DateTime @default(now())

Â  userÂ  Â  UserÂ  Â  @relation(fields: [userId], references: [id])
}

model Message {
  id        Int      @id @default(autoincrement())
  sender    String
  text      String
  role      String   @default("guest") // guest | admin | bot
  roomId    String
  createdAt DateTime @default(now())
}

model RenderResult {
  id          Int      @id @default(autoincrement())
  vaseName    String
  patternFile String
  resultImage String
  createdAt   DateTime @default(now())
}