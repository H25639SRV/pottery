# ===============================
# üß± STAGE 1: Build Frontend (React/Vue/etc.)
# ===============================
FROM node:20-alpine AS frontend_builder

WORKDIR /app

# Khai b√°o ARG ƒë·ªÉ nh·∫≠n gi√° tr·ªã t·ª´ docker-compose
ARG REACT_APP_API_URL
ARG REACT_APP_CLIENT_URL
ARG REACT_APP_CHAT_API_URL

# Chuy·ªÉn ARG th√†nh ENV ƒë·ªÉ React ƒë·ªçc ƒë∆∞·ª£c
ENV REACT_APP_API_URL=$REACT_APP_API_URL
ENV REACT_APP_CLIENT_URL=$REACT_APP_CLIENT_URL
ENV REACT_APP_CHAT_API_URL=$REACT_APP_CHAT_API_URL

# 1. Copy package files and install dependencies
# Gi·∫£ ƒë·ªãnh package.json c·ªßa frontend n·∫±m trong th∆∞ m·ª•c frontend/
COPY package*.json ./
RUN npm install

# 2. Copy source code
COPY . .

# 3. Build the static assets
# Thay th·∫ø "npm run build" b·∫±ng l·ªánh build ph√π h·ª£p n·∫øu c·∫ßn (v√≠ d·ª•: yarn build)

RUN echo "Debug API URL: $REACT_APP_API_URL"
RUN npm run build 

# ===============================
# üèÉ STAGE 2: Serve Static Files using Nginx
# ===============================
FROM nginx:alpine AS runner

# 1. Copy Nginx config (d√πng file b√™n d∆∞·ªõi)
COPY ./nginx.conf /etc/nginx/conf.d/default.conf

# 2. Copy built assets from the builder stage to Nginx's public directory
# Gi·∫£ ƒë·ªãnh th∆∞ m·ª•c output sau build l√† 'build'
COPY --from=frontend_builder /app/build /usr/share/nginx/html

# Expose port 80 - Nginx container's default listening port
EXPOSE 80 
# CMD m·∫∑c ƒë·ªãnh c·ªßa Nginx l√† ch·∫°y foreground